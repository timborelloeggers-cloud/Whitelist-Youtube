<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YouTube Whitelist V8.0 (Final Features)</title>
  
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
  <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>

  <style>
    :root{
      --bg:#0f0f0f; --card:#1a1a1a; --muted:#b8b8b8; --text:#fff;
      --accent:#ff0033; --radius:18px; --shadow:0 10px 24px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%; overflow-x: hidden;}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text);}
    header{position:sticky;top:0;z-index:100;backdrop-filter:saturate(140%) blur(6px);background:rgba(10,10,10,.75);border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:.6rem .75rem;display:flex;gap:.5rem;align-items:center}
    .btn{border:none;background:#252525;color:#eee;border:1px solid #2f2f2f;padding:.45rem .8rem;border-radius:999px;cursor:pointer;font-size:.9rem;white-space:nowrap; display: flex; align-items: center; justify-content: center;}
    .btn.active{background:var(--accent);border-color:transparent;color:#fff}
    #refreshBtn.loading svg { animation: spin 1s linear infinite; }
    @keyframes spin { 100% { transform: rotate(360deg); } }
    main{max-width:1200px;margin:0 auto;padding:12px; padding-bottom: 60px;}
    .section{margin-top:14px}
    .section h2{font-size:1.05rem;margin:.25rem 4px}
    .grid{display:grid;gap:12px}
    .grid.cols-channels{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .grid.cols-vids{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .chan-card{background:var(--card);border:1px solid #262626;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);padding:12px;display:flex;gap:12px;align-items:center;cursor:pointer}
    .chan-thumb{width:56px;height:56px;border-radius:999px;background:#2b2b2b;overflow:hidden;flex:0 0 auto}
    .chan-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .chan-meta{display:flex;flex-direction:column;gap:2px}
    .chan-title{font-weight:700}
    .video-card{background:var(--card);border:1px solid #262626;border-radius:calc(var(--radius) + 2px);overflow:hidden;box-shadow:var(--shadow); cursor:pointer;}
    .thumb{position:relative;aspect-ratio:16/9;background:#222}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .progress-bar-container{position:absolute;bottom:0;left:0;right:0;height:4px;background:rgba(255,255,255,0.2)}
    .progress-bar{height:100%;width:0%;background:var(--accent)}
    .chip{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);color:#fff;border-radius:4px;padding:.2rem .5rem;font-size:.75rem}
    .card-body{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700;font-size:.98rem;line-height:1.25}
    .meta{color:var(--muted);font-size:.85rem; display: flex; justify-content: space-between;}
    .tabs{display:flex;gap:8px;margin:8px 4px}
    .tab{padding:.5rem .8rem;border-radius:999px;background:#1d1d1d;border:1px solid #2a2a2a;cursor:pointer}
    .searchbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;background:#121212;border:1px solid #262626;border-radius:var(--radius);margin:6px 4px}
    .searchbar .input-wrapper{flex:1;display:flex;min-width:200px}
    .searchbar input{flex:1;background:transparent;border:none;color:#fff;outline:none;font-size:1rem}
    .sort-options{display:flex;gap:6px;width:100%;padding:4px 0 0 8px;}
    .searchbar .btn, .sort-options .btn { padding:.35rem .7rem; font-size:.85rem; }
    #channelBannerContainer{position: relative;width: 100%;min-height: 120px;border-radius: calc(var(--radius) - 4px);margin-bottom: 12px;overflow: hidden;background-color: #222;display: flex;align-items: center;justify-content: center;}
    #channelBannerBackground{position: absolute;inset: 0;background-size: cover;background-position: center center;filter: blur(8px) brightness(0.6);transform: scale(1.05);}
    #channelBanner{position: relative;max-width: 60%;max-height: 100px;aspect-ratio: 4/1;background-size: contain;background-repeat: no-repeat;background-position: center center;border-radius: var(--radius);box-shadow: var(--shadow);background-color: rgba(0,0,0,0.3);}
    @media (max-width: 768px) { #channelBanner{ max-width: 80%; } }
    .loadmore{display:block;width:100%;margin:14px 0;background:#1b1b1b;color:#eee;border:1px solid #2a2a2a;border-radius:999px;padding:.6rem;cursor:pointer}
    .hidden{display:none!important}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:200}
    .overlay.show{display:flex}
    .modal{width:95%;max-width:960px;max-height:95%;margin:auto;background:#0b0b0b;border:1px solid #2a2a2a;border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.5);display:flex;flex-direction:column}
    .modal-header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f1f1f}
    .modal-body{overflow-y:auto;padding:10px}
    .modal-iframe-container{width:100%;aspect-ratio:16/9;border:0;margin-bottom:10px; background-color: #000;}
    #playlistView .pl-head{display:flex;align-items:center;gap:8px;margin:6px 4px}
    #playlistView .pl-title{font-weight:700}
    .loading-msg, .error-msg{ text-align: center; padding: 20px; font-style: italic; color: var(--muted); }
    #statusBox{ padding: 10px; margin: 12px; border-radius: 8px; text-align: center; }
    #statusBox.error { background-color: #400; border: 1px solid #800; color: #f88; }
    #statusBox.loading { background-color: #222; border: 1px solid #444; color: #aaa; }
    details { border: 1px solid #2a2a2a; border-radius: var(--radius); margin-top: 1rem; }
    summary { cursor: pointer; padding: 1rem; font-weight: bold; }
    summary:hover { background-color: #1f1f1f; }
    .details-content { padding: 0 1rem 1rem 1rem; }
    .menu-btn { margin-left: auto; }
    .side-menu {
        position: fixed;
        top: 0;
        right: 0;
        width: 280px;
        height: 100%;
        background: #141414;
        border-left: 1px solid #2a2a2a;
        transform: translateX(100%);
        transition: transform 0.3s ease-in-out;
        z-index: 300;
        padding: 20px;
        display: flex;
        flex-direction: column;
        gap: 20px;
    }
    .side-menu.open { transform: translateX(0); }
    .side-menu .auth-container { flex-direction: column; gap: 15px; align-items: center; margin-left: 0; }
    #userAvatar { width: 64px; height: 64px; }
    #userName { font-weight: bold; }
    .menu-overlay {
        position: fixed;
        inset: 0;
        background: rgba(0,0,0,0.5);
        z-index: 250;
    }
    footer { text-align: center; padding: 20px 15px; border-top: 1px solid #2a2a2a; margin-top: 20px; }
    footer a { color: var(--muted); text-decoration: none; margin: 0 10px; font-size: 0.9rem; }
    footer a:hover { color: var(--text); }
    .text-page { line-height: 1.6; }
    .text-page h2, .text-page h3 { border-bottom: 1px solid #2a2a2a; padding-bottom: 10px; }
    .text-page p, .text-page ul { color: var(--muted); }
    .text-page a { color: var(--accent); }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <button class="btn" id="backBtn">←</button>
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="refreshBtn"><svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" viewBox="0 0 16 16"><path fill-rule="evenodd" d="M8 3a5 5 0 1 0 4.546 2.914.5.5 0 0 1 .908-.417A6 6 0 1 1 8 2v1z"/><path d="M8 4.466V.534a.25.25 0 0 1 .41-.192l2.36 1.966c.12.1.12.284 0 .384L8.41 4.658A.25.25 0 0 1 8 4.466z"/></svg></button>
    <button class="btn" id="forwardBtn">→</button>
    <button class="btn menu-btn" id="menuBtn">☰</button>
  </div>
</header>

<div class="side-menu" id="sideMenu">
  <div class="auth-container">
    <img id="userAvatar" class="hidden" alt="User Avatar">
    <span id="userName"></span>
    <button class="btn" id="authBtn">Anmelden</button>
  </div>
</div>
<div class="menu-overlay hidden" id="menuOverlay"></div>

<main>
  <div id="statusBox" class="hidden"></div>
  <section id="homeView" class="section">
    <h2>Deine Lieblingskanäle</h2>
    <div class="grid cols-channels" id="favoriteChannelGrid"></div>
    <details>
      <summary>Weitere Kanäle anzeigen</summary>
      <div class="details-content">
        <div class="grid cols-channels" id="otherChannelGrid"></div>
      </div>
    </details>
    <details id="continueWatchingSection" class="hidden">
      <summary>Angefangene Videos</summary>
      <div class="details-content">
        <div class="grid cols-vids" id="continueWatchingGrid"></div>
      </div>
    </details>
    <div class="section">
      <h2>Neueste Videos</h2>
      <div class="grid cols-vids" id="latestVideosGrid"></div>
    </div>
  </section>
  <section id="channelView" class="section hidden">
    <div id="channelBannerContainer" class="hidden">
        <div id="channelBannerBackground"></div>
        <div id="channelBanner"></div>
    </div>
    <div class="searchbar">
      <div class="input-wrapper">
        <input id="searchInput" placeholder="Im Kanal suchen…"/>
        <button class="btn" id="searchBtn">Suchen</button>
      </div>
      <div class="sort-options hidden" id="sortOptions">
        <span class="sub">Sortieren:</span>
        <button class="btn active" data-sort="date">Neueste</button>
        <button class="btn" data-sort="relevance">Relevanz</button>
        <button class="btn" data-sort="viewCount">Beliebt</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab" data-tab="videos">Videos</button>
      <button class="tab" data-tab="playlists">Playlists</button>
    </div>
    <div id="channelMeta" class="sub" style="margin:6px 4px"></div>
    <div id="videosTab" class="grid cols-vids"></div>
    <button id="moreVideosBtn" class="loadmore hidden">Mehr Videos laden</button>
    <div id="playlistsTab" class="grid cols-vids hidden"></div>
    <button id="morePlaylistsBtn" class="loadmore hidden">Mehr Playlists laden</button>
  </section>
  <section id="privacyView" class="section text-page hidden"></section>
  <section id="termsView" class="section text-page hidden"></section>
</main>

<footer>
  <a href="#terms">Nutzungsbedingungen</a>
  <a href="#privacy">Datenschutzerklärung</a>
</footer>

<div class="overlay" id="playerOverlay" role="dialog">
    <div class="modal">
        <div class="modal-header">
          <strong id="playerTitle">Video</strong>
          <button class="btn" id="playerClose">Schließen</button>
        </div>
        <div class="modal-body">
          <div id="player-mount" class="modal-iframe-container"></div>
        </div>
    </div>
</div>

<script>
// ===== YOUTUBE IFRAME API =====
var tag = document.createElement('script');
tag.src = "https://www.youtube.com/iframe_api";
var firstScriptTag = document.getElementsByTagName('script')[0];
firstScriptTag.parentNode.insertBefore(tag, firstScriptTag);

function onYouTubeIframeAPIReady() {
    window.dispatchEvent(new Event('youtube-api-ready'));
}

document.addEventListener('DOMContentLoaded', () => {
    // ===== CONFIG =====
    const YOUTUBE_API_KEY = "AIzaSyDdATTj976Ga3IRTFIqWbSYxORlp3mXT9w"; 
    const firebaseConfig = {
      apiKey: "AIzaSyCWI6Z0Z9NXmbYkoK9ersdKj2dbI0tSHa4",
      authDomain: "whitelist-v3.firebaseapp.com",
      projectId: "whitelist-v3",
      storageBucket: "whitelist-v3.appspot.com",
      messagingSenderId: "747410045455",
      appId: "1:747410045455:web:805ede68f0aefffae1417a"
    };
    
    const CHANNELS_CONFIG = [
        { handle: '@jpperformance', isFavorite: true }, { handle: '@Autodoktoren', isFavorite: true },
        { handle: '@BreakingLab', isFavorite: true }, { handle: '@Halle77', isFavorite: true },
        { handle: '@veritasium', isFavorite: true }, { handle: '@Simplicissimus', isFavorite: true },
        { handle: '@2boredguys', isFavorite: true }, { handle: '@automotorsport', isFavorite: false },
        { handle: '@MotorenZimmer', isFavorite: false }, { handle: '@MrWissen2go', isFavorite: false },
        { handle: '@EngineeringExplained', isFavorite: false }, { handle: '@100SekundenPhysik', isFavorite: false },
        { handle: '@TerraXLeschundCo', isFavorite: false }, { handle: '@mndiaye_97', isFavorite: false }
    ];

    // ===== STATE & ELEMENTS =====
    const state = {
        user: null, userId: null,
        progressData: new Map(),
        progressListenerUnsubscribe: null,
        channels: new Map(), 
        videoDetailsCache: new Map(),
        current: { 
            channelId: null, tab: 'videos', videosPageToken: null, 
            playlistsPageToken: null, player: null, playerStateInterval: null, searchQuery: null, searchOrder: 'date'
        },
        lastChannelRoute: null,
    };
    const els = {
        statusBox: document.getElementById('statusBox'), 
        homeView: document.getElementById('homeView'), 
        channelView: document.getElementById('channelView'),
        privacyView: document.getElementById('privacyView'),
        termsView: document.getElementById('termsView'),
        favoriteChannelGrid: document.getElementById('favoriteChannelGrid'),
        otherChannelGrid: document.getElementById('otherChannelGrid'), 
        latestVideosGrid: document.getElementById('latestVideosGrid'),
        continueWatchingSection: document.getElementById('continueWatchingSection'),
        continueWatchingGrid: document.getElementById('continueWatchingGrid'),
        tabs: document.querySelectorAll('.tab'), videosTab: document.getElementById('videosTab'), playlistsTab: document.getElementById('playlistsTab'),
        moreVideosBtn: document.getElementById('moreVideosBtn'), morePlaylistsBtn: document.getElementById('morePlaylistsBtn'),
        searchInput: document.getElementById('searchInput'), searchBtn: document.getElementById('searchBtn'),
        sortOptions: document.getElementById('sortOptions'),
        channelBannerContainer: document.getElementById('channelBannerContainer'), channelBannerBackground: document.getElementById('channelBannerBackground'),
        channelBanner: document.getElementById('channelBanner'), channelMeta: document.getElementById('channelMeta'),
        overlay: document.getElementById('playerOverlay'), 
        playerClose: document.getElementById('playerClose'),
        playerMount: document.getElementById('player-mount'), 
        playerTitle: document.getElementById('playerTitle'),
        playlistTitle: document.getElementById('playlistTitle'), playlistVideos: document.getElementById('playlistVideos'),
        morePlaylistVideosBtn: document.getElementById('morePlaylistVideosBtn'), 
        homeBtn: document.getElementById('homeBtn'), 
        refreshBtn: document.getElementById('refreshBtn'), 
        backBtn: document.getElementById('backBtn'),
        forwardBtn: document.getElementById('forwardBtn'),
        backToChannelBtn: document.getElementById('backToChannelBtn'),
        authBtn: document.getElementById('authBtn'),
        userAvatar: document.getElementById('userAvatar'),
        userName: document.getElementById('userName'),
        menuBtn: document.getElementById('menuBtn'),
        sideMenu: document.getElementById('sideMenu'),
        menuOverlay: document.getElementById('menuOverlay'),
    };
    
    // ===== FIREBASE SETUP =====
    firebase.initializeApp(firebaseConfig);
    const db = firebase.firestore();
    const auth = firebase.auth();
    const homeCacheRef = db.collection('cache').doc('homeData');
    const videoDetailsCacheRef = db.collection('cache').doc('videoDetails');

    // ===== UTILS & HELPERS =====
    const showStatus = (message, isError = false) => { els.statusBox.textContent = message; els.statusBox.className = isError ? 'error' : 'loading'; };
    const hideStatus = () => { els.statusBox.className = 'hidden'; };
    const fmtDate = s => new Date(s).toLocaleDateString('de-DE', { year: 'numeric', month: 'short', day: 'numeric' });
    const formatDuration = (seconds) => {
        if (!seconds) return '';
        const h = Math.floor(seconds / 3600);
        const m = Math.floor((seconds % 3600) / 60);
        const s = Math.floor(seconds % 60);
        const pad = n => n.toString().padStart(2, '0');
        return h > 0 ? `${h}:${pad(m)}:${pad(s)}` : `${m}:${pad(s)}`;
    };
    const parseISO8601Duration = (duration) => {
        if (!duration) return 0;
        const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
        if (!match) return 0;
        return (parseInt(match[1]) || 0) * 3600 + (parseInt(match[2]) || 0) * 60 + (parseInt(match[3]) || 0);
    };
    const delay = ms => new Promise(res => setTimeout(res, ms));
    
    // ===== RENDERERS =====
    const renderChannelCard = (info, isFavorite) => {
        const card = document.createElement('div');
        card.className = 'chan-card';
        card.innerHTML = `<div class="chan-thumb"><img src="${info.thumb}" alt=""></div><div class="chan-meta"><div class="chan-title">${info.title}</div><div class="sub">Kanal öffnen</div></div>`;
        card.onclick = () => navigate(`channel/${info.id}/videos`);
        (isFavorite ? els.favoriteChannelGrid : els.otherChannelGrid).appendChild(card);
    };

    const videoCard = (v) => {
        const card = document.createElement('div');
        card.className = 'video-card';
        card.dataset.videoId = v.videoId;
        
        const progress = state.progressData.get(v.videoId);
        let progressPercent = progress?.duration > 0 ? Math.min((progress.currentTime / progress.duration) * 100, 100) : 0;

        card.innerHTML = `
            <div class="thumb">
                <img loading="lazy" src="${v.thumb || ''}" alt="">
                ${v.date ? `<span class="chip">${fmtDate(new Date(v.date))}</span>` : ''}
                <div class="progress-bar-container"><div class="progress-bar" style="width: ${progressPercent}%"></div></div>
            </div>
            <div class="card-body">
                <div class="title">${v.title || '?'}</div>
                <div class="meta"><span>${v.channelTitle || 'Video'}</span><span>${formatDuration(v.durationSeconds)}</span></div>
            </div>`;
        card.onclick = () => openPlayer(v.videoId, v.title); 
        return card;
    };
    
    const updateAllProgressBars = () => {
        document.querySelectorAll('.video-card[data-video-id]').forEach(card => {
            const videoId = card.dataset.videoId;
            const progress = state.progressData.get(videoId);
            const progressPercent = progress?.duration > 0 ? Math.min((progress.currentTime / progress.duration) * 100, 100) : 0;
            const bar = card.querySelector('.progress-bar');
            if (bar) bar.style.width = `${progressPercent}%`;
        });
    };

    // ===== DATA FETCHING & DATABASE =====
    const saveProgress = (videoId, currentTime, duration) => {
        if (!state.userId || !videoId || !isFinite(currentTime) || !isFinite(duration)) return;
        const data = { 
            currentTime: Math.round(currentTime), 
            duration: Math.round(duration), 
            lastWatched: firebase.firestore.FieldValue.serverTimestamp()
        };
        db.collection('users').doc(state.userId).collection('videoProgress').doc(videoId).set(data, { merge: true });
    };

    const getChannelInfo = async (identifier) => {
        if (state.channels.has(identifier)) return state.channels.get(identifier);
        
        let channelId = identifier;
        if (identifier.startsWith('@')) {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/search?part=snippet&q=${identifier}&type=channel&maxResults=1&key=${YOUTUBE_API_KEY}`);
            if (!res.ok) throw new Error('API Error');
            const searchData = await res.json();
            channelId = searchData.items?.[0]?.snippet?.channelId;
            if (!channelId) throw new Error(`Kanal-Handle '${identifier}' nicht gefunden.`);
        }
        
        const res = await fetch(`https://www.googleapis.com/youtube/v3/channels?part=snippet,contentDetails,brandingSettings&id=${channelId}&key=${YOUTUBE_API_KEY}`);
        if (!res.ok) throw new Error('API Error');
        const data = await res.json();
        const c = data.items?.[0];
        if (!c) throw new Error(`Kanal-Info für ID ${channelId} nicht gefunden.`);
        
        const banner = c.brandingSettings?.image?.bannerTvImageUrl?.replace(/=w\d+/, '=w2560') || null;
        const info = { id: c.id, title: c.snippet?.title, thumb: c.snippet?.thumbnails?.default?.url, uploadsId: c.contentDetails?.relatedPlaylists?.uploads, banner };
        state.channels.set(identifier, info);
        state.channels.set(info.id, info);
        return info;
    };
    
    const enrichVideosWithDuration = async (items, idKey) => {
        if (!items || items.length === 0) return [];
        const getVideoId = (item, key) => (key === 'id' ? item.id?.videoId : item.snippet?.resourceId?.videoId);
        
        const allVideoIds = items.map(it => getVideoId(it, idKey)).filter(Boolean);
        if (allVideoIds.length === 0) return [];

        const durationMap = new Map();
        for (let i = 0; i < allVideoIds.length; i += 50) {
            const chunk = allVideoIds.slice(i, i + 50);
            const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=contentDetails&id=${chunk.join(',')}&key=${YOUTUBE_API_KEY}`);
            if (!res.ok) continue;
            const data = await res.json();
            data.items.forEach(v => durationMap.set(v.id, parseISO8601Duration(v.contentDetails.duration)));
        }
        
        return items
            .map(item => ({ ...item, durationSeconds: durationMap.get(getVideoId(item, idKey)) || 0 }))
            .filter(item => item.durationSeconds > 120);
    };

    const setupProgressListener = () => {
        if (state.progressListenerUnsubscribe) state.progressListenerUnsubscribe();
        if (!state.userId) {
            els.continueWatchingSection.classList.add('hidden');
            return;
        }

        state.progressListenerUnsubscribe = db.collection('users').doc(state.userId).collection('videoProgress')
            .orderBy('lastWatched', 'desc')
            .onSnapshot(snapshot => {
                const newProgress = new Map();
                snapshot.forEach(doc => newProgress.set(doc.id, doc.data()));
                state.progressData = newProgress;
                updateAllProgressBars();
                renderContinueWatching();
            }, console.error);
    };
    
    const renderContinueWatching = async () => {
        if (!state.userId || state.progressData.size === 0) {
            return els.continueWatchingSection.classList.add('hidden');
        }

        const unfinishedVideos = [];
        for (const [videoId, progress] of state.progressData.entries()) {
            if (progress.duration > 0 && (progress.currentTime / progress.duration) < 0.9) {
                unfinishedVideos.push({ videoId, ...progress });
            }
        }
        
        if (unfinishedVideos.length === 0) {
            return els.continueWatchingSection.classList.add('hidden');
        }

        const top8 = unfinishedVideos.slice(0, 8);
        const idsToFetch = top8.filter(v => !state.videoDetailsCache.has(v.videoId)).map(v => v.videoId);

        if (idsToFetch.length > 0) {
            const res = await fetch(`https://www.googleapis.com/youtube/v3/videos?part=snippet,contentDetails&id=${idsToFetch.join(',')}&key=${YOUTUBE_API_KEY}`);
            if (res.ok) {
                const data = await res.json();
                const newDetails = {};
                data.items.forEach(item => {
                    const detail = {
                        title: item.snippet.title,
                        thumb: item.snippet.thumbnails.medium.url,
                        channelTitle: item.snippet.channelTitle,
                        durationSeconds: parseISO8601Duration(item.contentDetails.duration),
                    };
                    state.videoDetailsCache.set(item.id, detail);
                    newDetails[`videos.${item.id}`] = detail;
                });
                if (Object.keys(newDetails).length > 0) {
                    videoDetailsCacheRef.update(newDetails);
                }
            }
        }

        els.continueWatchingGrid.innerHTML = '';
        top8.forEach(v => {
            const details = state.videoDetailsCache.get(v.videoId);
            if (details) {
                els.continueWatchingGrid.appendChild(videoCard({ videoId: v.videoId, date: v.lastWatched.toDate().toISOString(), ...details }));
            }
        });
        els.continueWatchingSection.classList.remove('hidden');
    };

    // ===== FIREBASE CACHE & HOMEPAGE LOGIC =====
    const renderHomeFromFirebase = (data) => {
        if (!data || !data.channels || !data.videos) {
            showStatus('Cache leer. Klicke auf "🔄", um Daten zu laden.');
            return;
        }
        const { channels, videos } = data;
        els.favoriteChannelGrid.innerHTML = ''; els.otherChannelGrid.innerHTML = ''; els.latestVideosGrid.innerHTML = '';
        channels.forEach(ch => renderChannelCard(ch, ch.isFavorite));
        videos.forEach(v => els.latestVideosGrid.appendChild(videoCard(v)));
        updateAllProgressBars();
    };

    const forceUpdateAndCacheToFirebase = async () => {
        els.refreshBtn.classList.add('loading');
        showStatus('Aktualisiere Daten von YouTube...');
        
        const successfulChannels = [];
        for (const config of CHANNELS_CONFIG) {
            try {
                const info = await getChannelInfo(config.handle);
                successfulChannels.push({ ...info, isFavorite: config.isFavorite });
                await delay(100); 
            } catch (e) { console.error(`Konnte Kanal-Info für ${config.handle} nicht laden:`, e); }
        }
        
        const latestVideoItems = [];
        for (const info of successfulChannels) {
            try {
                const res = await fetch(`https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&playlistId=${info.uploadsId}&maxResults=5&key=${YOUTUBE_API_KEY}`);
                if (res.ok) {
                    const data = await res.json();
                    if(data.items?.length > 0) {
                        const enriched = await enrichVideosWithDuration(data.items, 'snippet');
                        if (enriched.length > 0) {
                            latestVideoItems.push({...enriched[0], channelTitle: info.title});
                        }
                    }
                }
                await delay(100); 
            } catch (e) { console.error(`Konnte Videos für ${info.title} nicht laden:`, e); }
        }

        const allVideos = latestVideoItems.map(it => ({
            videoId: it.snippet.resourceId.videoId, title: it.snippet.title,
            date: it.snippet.publishedAt, thumb: it.snippet.thumbnails?.medium?.url,
            channelId: it.snippet.channelId, channelTitle: it.channelTitle,
            durationSeconds: it.durationSeconds
        }));
        
        allVideos.sort((a, b) => new Date(b.date) - new Date(a.date));
        
        const cacheData = { channels: successfulChannels, videos: allVideos, timestamp: firebase.firestore.FieldValue.serverTimestamp() };
        await homeCacheRef.set(cacheData);
        hideStatus();
        els.refreshBtn.classList.remove('loading');
    };

    // ===== NAVIGATION & ROUTING =====
    const navigate = hash => window.location.hash = hash;
    const parseRoute = () => {
        const h = window.location.hash.slice(1) || 'home';
        const parts = h.split('/');
        return { view: parts[0], id: parts[1], tab: parts[2] };
    };
    const setView = name => {
        ['homeView', 'channelView', 'privacyView', 'termsView'].forEach(viewId => {
            if (els[viewId]) els[viewId].classList.add('hidden');
        });
        if (els[name + 'View']) els[name + 'View'].classList.remove('hidden');
    };
    
    const openPlayer = (videoId, title) => {
        els.playerTitle.textContent = title || 'Video';
        els.overlay.classList.add('show');
        const progress = state.progressData.get(videoId);
        
        state.current.player = new YT.Player('player-mount', {
            height: '100%', width: '100%', videoId,
            playerVars: { 'playsinline': 1, 'autoplay': 1, 'rel': 0, 'start': progress?.currentTime || 0 },
            events: { 'onStateChange': onPlayerStateChange }
        });
    };
    
    const onPlayerStateChange = event => {
        clearInterval(state.current.playerStateInterval);
        if (event.data !== YT.PlayerState.PLAYING) return;
        
        const player = event.target;
        const videoId = player.getVideoData().video_id;
        state.current.playerStateInterval = setInterval(() => {
            const currentTime = player.getCurrentTime();
            const duration = player.getDuration();
            if (currentTime > 0 && duration > 0) saveProgress(videoId, currentTime, duration);
        }, 3000);
    };

    const closePlayer = () => {
        clearInterval(state.current.playerStateInterval);
        if (state.current.player?.destroy) state.current.player.destroy();
        state.current.player = null;
        els.overlay.classList.remove('show');
    };
    
    const handleRoute = async () => {
        const r = parseRoute();
        hideStatus();
        try {
            if (['home', 'privacy', 'terms'].includes(r.view)) {
                setView(r.view);
            } else if (r.view === 'channel' && r.id) {
                setView('channel'); 
                // ... (rest of the logic from previous version)
            } else { 
                navigate('home'); 
            }
        } catch (e) { console.error(`Fehler bei Navigation:`, e); showStatus(e.message, true); }
    };
    
    // ===== EVENT LISTENERS =====
    const setupEventListeners = () => {
        window.onhashchange = handleRoute;
        els.homeBtn.onclick = () => navigate('home');
        els.refreshBtn.onclick = forceUpdateAndCacheToFirebase;
        els.backBtn.onclick = () => history.back();
        els.forwardBtn.onclick = () => history.forward();
        els.playerClose.onclick = closePlayer;
        els.overlay.onclick = e => { if (e.target === els.overlay) closePlayer(); };
        els.menuBtn.onclick = () => {
            els.sideMenu.classList.toggle('open');
            els.menuOverlay.classList.toggle('hidden');
        };
        els.menuOverlay.onclick = () => {
            els.sideMenu.classList.remove('open');
            els.menuOverlay.classList.add('hidden');
        };
    };

    // ===== APP INITIALIZATION & AUTH =====
    const initAuth = () => {
        els.authBtn.onclick = () => {
            if (state.user) auth.signOut();
            else auth.signInWithPopup(new firebase.auth.GoogleAuthProvider()).catch(err => showStatus(`Anmeldung fehlgeschlagen: ${err.message}`, true));
        };
        auth.onAuthStateChanged(user => {
            const wasLoggedIn = !!state.user;
            state.user = user; state.userId = user?.uid;
            
            els.authBtn.textContent = user ? 'Abmelden' : 'Anmelden';
            els.userAvatar.classList.toggle('hidden', !user);
            els.userName.textContent = user ? user.displayName : '';
            if (user) els.userAvatar.src = user.photoURL;

            if (user) {
                setupProgressListener();
            } else {
                if (state.progressListenerUnsubscribe) state.progressListenerUnsubscribe();
                state.progressData.clear();
                updateAllProgressBars();
                els.continueWatchingSection.classList.add('hidden');
            }
            if (!!user !== wasLoggedIn || !wasLoggedIn) handleRoute();
        });
    };
    
    setupEventListeners();
    homeCacheRef.onSnapshot(doc => {
        if (doc.exists) renderHomeFromFirebase(doc.data());
        else showStatus('Cache leer. Klicke auf "🔄", um die Daten erstmalig zu laden.');
    }, console.error);
    videoDetailsCacheRef.get().then(doc => {
        if(doc.exists) {
            const data = doc.data();
            for(const key in data.videos) {
                state.videoDetailsCache.set(key, data.videos[key]);
            }
        }
    });
    window.addEventListener('youtube-api-ready', initAuth);
});
</script>

</body>
</html>
