<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1, viewport-fit=cover" />
  <title>YouTube Whitelist</title>
  <style>
    :root{
      --bg:#0f0f0f; --card:#1a1a1a; --muted:#b8b8b8; --text:#fff;
      --accent:#ff0033; --radius:18px; --shadow:0 10px 24px rgba(0,0,0,.35)
    }
    *{box-sizing:border-box}
    html,body{height:100%}
    body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,Helvetica,Arial;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:100;backdrop-filter:saturate(140%) blur(6px);background:rgba(10,10,10,.75);border-bottom:1px solid rgba(255,255,255,.06)}
    .topbar{max-width:1200px;margin:0 auto;padding:.6rem .75rem;display:flex;gap:.5rem;align-items:center}
    .btn{border:none;background:#252525;color:#eee;border:1px solid #2f2f2f;padding:.45rem .8rem;border-radius:999px;cursor:pointer;font-size:.9rem;}
    .btn.active{background:var(--accent);border-color:transparent;color:#fff}
    .pill{display:inline-flex;align-items:center;gap:.4rem;padding:.45rem .7rem;border-radius:999px;background:#1c1c1c;border:1px solid #2a2a2a;color:#eee}
    main{max-width:1200px;margin:0 auto;padding:12px}
    .section{margin-top:14px}
    .section h2{font-size:1.05rem;margin:.25rem 4px}
    .sub{color:var(--muted);font-size:.9rem}
    .grid{display:grid;gap:12px}
    .grid.cols-channels{grid-template-columns:repeat(auto-fill,minmax(220px,1fr))}
    .grid.cols-vids{grid-template-columns:repeat(auto-fill,minmax(280px,1fr))}
    .chan-card{background:var(--card);border:1px solid #262626;border-radius:var(--radius);overflow:hidden;box-shadow:var(--shadow);padding:12px;display:flex;gap:12px;align-items:center;cursor:pointer}
    .chan-thumb{width:56px;height:56px;border-radius:999px;background:#2b2b2b;overflow:hidden;flex:0 0 auto}
    .chan-thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .chan-meta{display:flex;flex-direction:column;gap:2px}
    .chan-title{font-weight:700}
    .video-card{background:var(--card);border:1px solid #262626;border-radius:calc(var(--radius) + 2px);overflow:hidden;box-shadow:var(--shadow); cursor:pointer;}
    .thumb{position:relative;aspect-ratio:16/9;background:#222}
    .thumb img{width:100%;height:100%;object-fit:cover;display:block}
    .chip{position:absolute;bottom:8px;right:8px;background:rgba(0,0,0,.7);color:#fff;border-radius:4px;padding:.2rem .5rem;font-size:.75rem}
    .card-body{padding:10px 12px;display:flex;flex-direction:column;gap:6px}
    .title{font-weight:700;font-size:.98rem;line-height:1.25}
    .meta{color:var(--muted);font-size:.85rem}
    .tabs{display:flex;gap:8px;margin:8px 4px}
    .tab{padding:.5rem .8rem;border-radius:999px;background:#1d1d1d;border:1px solid #2a2a2a;cursor:pointer}
    .tab.active{background:var(--accent);border-color:transparent;color:#fff}
    .searchbar{display:flex;flex-wrap:wrap;gap:8px;align-items:center;padding:8px;background:#121212;border:1px solid #262626;border-radius:var(--radius);margin:6px 4px}
    .searchbar .input-wrapper{flex:1;display:flex;min-width:200px}
    .searchbar input{flex:1;background:transparent;border:none;color:#fff;outline:none;font-size:1rem}
    .sort-options{display:flex;gap:6px;width:100%;padding:4px 0 0 8px;}
    .searchbar .btn, .sort-options .btn { padding:.35rem .7rem; font-size:.85rem; }
    #channelBannerContainer{position: relative;width: 100%;min-height: 120px;border-radius: calc(var(--radius) - 4px);margin-bottom: 12px;overflow: hidden;background-color: #222;display: flex;align-items: center;justify-content: center;}
    #channelBannerBackground{position: absolute;inset: 0;background-size: cover;background-position: center center;filter: blur(8px) brightness(0.6);transform: scale(1.05);}
    #channelBanner{position: relative;max-width: 60%;max-height: 100px;aspect-ratio: 4/1;background-size: contain;background-repeat: no-repeat;background-position: center center;border-radius: var(--radius);box-shadow: var(--shadow);background-color: rgba(0,0,0,0.3);}
    @media (max-width: 768px) { #channelBanner{ max-width: 80%; } }
    .loadmore{display:block;width:100%;margin:14px 0;background:#1b1b1b;color:#eee;border:1px solid #2a2a2a;border-radius:999px;padding:.6rem;cursor:pointer}
    .hidden{display:none!important}
    .overlay{position:fixed;inset:0;background:rgba(0,0,0,.7);backdrop-filter:blur(4px);display:none;align-items:center;justify-content:center;z-index:200}
    .overlay.show{display:flex}
    .modal{width:95%;max-width:960px;max-height:95%;margin:auto;background:#0b0b0b;border:1px solid #2a2a2a;border-radius:16px;overflow:hidden;box-shadow:0 20px 40px rgba(0,0,0,.5);display:flex;flex-direction:column}
    .modal-header{flex-shrink:0;display:flex;align-items:center;justify-content:space-between;padding:10px 12px;border-bottom:1px solid #1f1f1f}
    .modal-body{overflow-y:auto;padding:10px}
    .modal iframe{width:100%;aspect-ratio:16/9;border:0;margin-bottom:10px}
    .suggest{display:flex;gap:10px;overflow-x:auto;padding-bottom:6px}
    .suggest .video-card{min-width:220px;}
    #playlistView .pl-head{display:flex;align-items:center;gap:8px;margin:6px 4px}
    #playlistView .pl-title{font-weight:700}
    .loading-msg, .error-msg{ text-align: center; padding: 20px; font-style: italic; color: var(--muted); }
    #statusBox{ padding: 10px; margin: 12px; border-radius: 8px; text-align: center; }
    #statusBox.error { background-color: #400; border: 1px solid #800; color: #f88; }
    #statusBox.loading { background-color: #222; border: 1px solid #444; color: #aaa; }
  </style>
</head>
<body>

<header>
  <div class="topbar">
    <button class="btn" id="backBtn">← Zurück</button>
    <button class="btn" id="homeBtn">Home</button>
    <button class="btn" id="forwardBtn">Weiter →</button>
    <div style="margin-left:auto; display: none;" class="pill" id="activeChannelPill"></div>
  </div>
</header>

<main>
  <div id="statusBox" class="hidden"></div>

  <section id="homeView" class="section">
    <h2>Deine Kanäle</h2>
    <div class="grid cols-channels" id="channelGrid"></div>
    <div class="section">
      <h2>Neueste Videos</h2>
      <div class="grid cols-vids" id="latestVideosGrid"></div>
    </div>
  </section>

  <section id="channelView" class="section hidden">
    <div id="channelBannerContainer" class="hidden">
        <div id="channelBannerBackground"></div>
        <div id="channelBanner"></div>
    </div>
    <div class="searchbar">
      <div class="input-wrapper">
        <input id="searchInput" placeholder="Im Kanal suchen…"/>
        <button class="btn" id="searchBtn">Suchen</button>
      </div>
      <div class="sort-options hidden" id="sortOptions">
        <span class="sub">Sortieren:</span>
        <button class="btn active" data-sort="date">Neueste</button>
        <button class="btn" data-sort="relevance">Relevanz</button>
        <button class="btn" data-sort="viewCount">Beliebt</button>
      </div>
    </div>
    <div class="tabs">
      <button class="tab" data-tab="videos">Videos</button>
      <button class="tab" data-tab="playlists">Playlists</button>
    </div>
    <div id="channelMeta" class="sub" style="margin:6px 4px"></div>
    <div id="videosTab" class="grid cols-vids"></div>
    <button id="moreVideosBtn" class="loadmore hidden">Mehr Videos laden</button>
    <div id="playlistsTab" class="grid cols-vids hidden"></div>
    <button id="morePlaylistsBtn" class="loadmore hidden">Mehr Playlists laden</button>
  </section>

  <section id="playlistView" class="section hidden">
    <div class="pl-head">
      <button class="btn" id="backToChannelBtn">← Zurück zum Kanal</button>
      <div class="pl-title" id="playlistTitle">Playlist</div>
    </div>
    <div id="playlistVideos" class="grid cols-vids" style="margin-top: 14px;"></div>
    <button id="morePlaylistVideosBtn" class="loadmore hidden">Mehr laden</button>
  </section>
</main>

<div class="overlay" id="playerOverlay" role="dialog">
  <div class="modal">
    <div class="modal-header">
      <strong id="playerTitle">Video</strong>
      <button class="btn" id="playerClose">Schließen</button>
    </div>
    <div class="modal-body">
      <iframe id="playerIframe" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture; web-share" allowfullscreen></iframe>
      <div>
        <div style="display:flex;align-items:center;justify-content:space-between;padding:0 2px;">
          <strong>Vorgeschlagene Videos</strong>
          <span class="sub" id="suggestSub"></span>
        </div>
        <div class="suggest" id="suggestList"></div>
      </div>
    </div>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', () => {
    // ===== CONFIG =====
    const API_KEY = "AIzaSyDdATTj976Ga3IRTFIqWbSYxORlp3mXT9w"; 
    
    const ALLOWED_CHANNELS = [
        "@jpperformance", "@MotorenZimmer", "@veritasium",
        "@3blue1brown", "@RealEngineering", "@Autodoktoren"
    ];

    // ===== STATE & ELEMENTS =====
    const state = {
        channels: new Map(), 
        current: { 
            channelId: null, tab: 'videos', videosPageToken: null, 
            playlistsPageToken: null, playlistVideosPageToken: null,
            searchQuery: null, searchOrder: 'date' 
        },
        lastChannelRoute: null, playlistContext: { playlistId: null, channelId: null, title: null }
    };
    const els = {
        statusBox: document.getElementById('statusBox'), homeView: document.getElementById('homeView'), channelView: document.getElementById('channelView'),
        playlistView: document.getElementById('playlistView'), channelGrid: document.getElementById('channelGrid'),
        latestVideosGrid: document.getElementById('latestVideosGrid'), tabs: document.querySelectorAll('.tab'),
        videosTab: document.getElementById('videosTab'), playlistsTab: document.getElementById('playlistsTab'),
        moreVideosBtn: document.getElementById('moreVideosBtn'), morePlaylistsBtn: document.getElementById('morePlaylistsBtn'),
        searchInput: document.getElementById('searchInput'), searchBtn: document.getElementById('searchBtn'),
        sortOptions: document.getElementById('sortOptions'), sortButtons: document.querySelectorAll('[data-sort]'),
        channelBannerContainer: document.getElementById('channelBannerContainer'),
        channelBannerBackground: document.getElementById('channelBannerBackground'),
        channelBanner: document.getElementById('channelBanner'),
        channelMeta: document.getElementById('channelMeta'), activeChannelPill: document.getElementById('activeChannelPill'),
        overlay: document.getElementById('playerOverlay'), playerClose: document.getElementById('playerClose'),
        playerIframe: document.getElementById('playerIframe'), playerTitle: document.getElementById('playerTitle'),
        suggestList: document.getElementById('suggestList'), suggestSub: document.getElementById('suggestSub'),
        playlistTitle: document.getElementById('playlistTitle'), playlistVideos: document.getElementById('playlistVideos'),
        morePlaylistVideosBtn: document.getElementById('morePlaylistVideosBtn'), backBtn: document.getElementById('backBtn'),
        homeBtn: document.getElementById('homeBtn'), forwardBtn: document.getElementById('forwardBtn'),
        backToChannelBtn: document.getElementById('backToChannelBtn'),
    };

    // ===== UTILS & HELPERS =====
    const showStatus = (message, isError = false) => { els.statusBox.textContent = message; els.statusBox.className = isError ? 'error' : 'loading'; };
    const hideStatus = () => { els.statusBox.className = 'hidden'; };
    const createEl = (tag, cls, html) => { const e = document.createElement(tag); if(cls) e.className = cls; if(html != null) e.innerHTML = html; return e; };
    const fmtDate = s => new Date(s).toLocaleDateString('de-DE', { year: 'numeric', month: 'short', day: 'numeric' });
    
    const parseISO8601Duration = (duration) => {
        if (!duration) return 0;
        const match = duration.match(/PT(\d+H)?(\d+M)?(\d+S)?/);
        if (!match) return 0;
        const hours = (parseInt(match[1]) || 0);
        const minutes = (parseInt(match[2]) || 0);
        const seconds = (parseInt(match[3]) || 0);
        return hours * 3600 + minutes * 60 + seconds;
    };

    const api = async (path, params = {}) => {
        const url = new URL(`https://www.googleapis.com/youtube/v3/${path}`);
        params.key = API_KEY; 
        Object.entries(params).forEach(([k, v]) => v && url.searchParams.set(k, v));
        const res = await fetch(url);
        if (!res.ok) {
            const errorData = await res.json();
            const reason = errorData.error?.errors?.[0]?.reason || 'unknownError';
            console.error('API Error Response:', errorData);
            let userMessage = `API Fehler (${res.status}): ${reason}.`;
            if (reason === 'quotaExceeded') userMessage = 'Das tägliche API-Kontingent (Quota) wurde überschritten.';
            throw new Error(userMessage);
        }
        return res.json();
    };
    
    // ===== RENDERERS =====
    const renderChannelCard = (info) => {
        const card = createEl('div', 'chan-card');
        card.innerHTML = `<div class="chan-thumb"><img src="${info.thumb}" alt=""></div><div class="chan-meta"><div class="chan-title">${info.title}</div><div class="sub">Kanal öffnen</div></div>`;
        card.addEventListener('click', () => navigate(`channel/${info.id}/videos`)); return card;
    };
    const videoCard = (v, context = {}) => {
        const card = createEl('div', 'video-card');
        card.innerHTML = `<div class="thumb"><img loading="lazy" src="${v.thumb || ''}" alt="">${v.date ? `<span class="chip">${fmtDate(v.date)}</span>` : ''}</div><div class="card-body"><div class="title">${v.title || '?'}</div><div class="meta">${v.channelTitle || 'Video'}</div></div>`;
        card.addEventListener('click', () => openPlayer(v.videoId, v.title, context)); return card;
    };
    const playlistCard = (p) => {
        const card = createEl('div', 'video-card');
        card.innerHTML = `<div class="thumb"><img loading="lazy" src="${p.thumb || ''}" alt="">${p.date ? `<span class="chip">${fmtDate(p.date)}</span>` : ''}</div><div class="card-body"><div class="title">${p.title || '?'}</div><div class="meta">${p.channelTitle || 'Playlist'}</div></div>`;
        card.addEventListener('click', () => openPlaylist(p.playlistId, p.channelId, p.title)); return card;
    };

    // ===== DATA FETCHING & DISPLAY LOGIC =====
    const getChannelInfo = async (identifier) => {
        if (state.channels.has(identifier) && state.channels.get(identifier).banner) {
             return state.channels.get(identifier);
        }
        let channelId = identifier;
        if (identifier.startsWith('@')) {
            const searchData = await api('search', { q: identifier, type: 'channel', part: 'snippet', maxResults: 1 });
            const searchResult = searchData.items?.[0];
            if (!searchResult) throw new Error(`Kanal-Handle '${identifier}' nicht gefunden.`);
            channelId = searchResult.snippet.channelId;
        }
        
        const data = await api('channels', { id: channelId, part: 'snippet,contentDetails,brandingSettings' });
        const c = data.items?.[0]; if (!c) throw new Error('Kanal-Info für ID: ' + channelId + ' nicht gefunden.');
        
        let banner = c.brandingSettings?.image?.bannerTvImageUrl 
                     || c.brandingSettings?.image?.bannerTabletImageUrl
                     || c.brandingSettings?.image?.bannerMobileImageUrl
                     || c.brandingSettings?.image?.bannerExternalUrl;
        
        if (banner) {
            banner = banner.replace(/=w\d+/, '=w2560');
        }

        const info = { 
            id: c.id, 
            title: c.snippet?.title || '?', 
            thumb: c.snippet?.thumbnails?.default?.url, 
            uploadsId: c.contentDetails?.relatedPlaylists?.uploads,
            banner: banner
        };
        state.channels.set(identifier, info);
        state.channels.set(info.id, info);
        return info;
    };
    
    const filterShortsByDuration = async (items, idKey = 'videoId') => {
        if (!items || items.length === 0) return [];
        
        // Helper function to get the video ID from different item structures
        const getVideoId = (item, key) => {
            if (key === 'contentDetails') return item.contentDetails?.videoId;
            if (key === 'id') return item.id?.videoId;
            return null;
        };

        const videoIds = items.map(it => getVideoId(it, idKey)).filter(Boolean).join(',');
        if (!videoIds) return [];

        const videoData = await api('videos', { id: videoIds, part: 'contentDetails' });
        
        const durationMap = new Map();
        videoData.items.forEach(v => {
            durationMap.set(v.id, parseISO8601Duration(v.contentDetails.duration));
        });
        
        return items.filter(it => {
            const videoId = getVideoId(it, idKey);
            return durationMap.get(videoId) > 120;
        });
    };

    const buildHome = async () => {
        showStatus('Lade Kanäle und neueste Videos...');
        els.channelGrid.innerHTML = ''; els.latestVideosGrid.innerHTML = '';
        
        const infoPromises = ALLOWED_CHANNELS.map(handle => getChannelInfo(handle));
        const infoResults = await Promise.allSettled(infoPromises);

        const successfulChannels = [];
        infoResults.forEach(result => {
            if (result.status === 'fulfilled' && result.value) {
                els.channelGrid.appendChild(renderChannelCard(result.value));
                successfulChannels.push(result.value);
            } else { console.error("Konnte Kanal-Info nicht laden:", result.reason); }
        });

        if (successfulChannels.length > 0) {
            const videoPromises = successfulChannels.map(info => api('playlistItems', { playlistId: info.uploadsId, maxResults: 5, part: 'snippet,contentDetails' }).then(data => ({...data, channelTitle: info.title })));
            const videoResults = await Promise.allSettled(videoPromises);
            
            let allItems = videoResults
                .filter(r => r.status === 'fulfilled' && r.value.items)
                .flatMap(r => r.value.items.map(item => ({...item, channelTitle: r.value.channelTitle })))
                .filter(it => it.contentDetails && it.contentDetails.videoId);

            const nonShorts = await filterShortsByDuration(allItems, 'contentDetails');

            const latestVideos = successfulChannels.map(info => {
                return nonShorts.find(v => v.snippet.channelId === info.id);
            }).filter(Boolean);

            const allVideos = latestVideos.map(it => ({
                    videoId: it.contentDetails.videoId, title: it.snippet.title,
                    date: it.snippet.publishedAt, thumb: it.snippet.thumbnails?.medium?.url,
                    channelId: it.snippet.channelId, channelTitle: it.channelTitle
                }));
            
            allVideos.sort((a, b) => new Date(b.date) - new Date(a.date));
            
            if (allVideos.length === 0) {
                els.latestVideosGrid.innerHTML = `<div class="loading-msg">Keine neuen Videos (länger als 2 Min.) gefunden.</div>`;
            } else {
                allVideos.forEach(v => els.latestVideosGrid.appendChild(videoCard(v, { channelId: v.channelId })));
            }
        } else {
             els.latestVideosGrid.innerHTML = `<div class="loading-msg">Keine Kanäle konnten geladen werden.</div>`;
        }
        hideStatus();
    };
    
    const showChannelContent = async (type, { reset = true } = {}) => {
        els.sortOptions.classList.add('hidden');
        els.searchInput.value = '';
        state.current.searchQuery = null;

        const isVideos = type === 'videos';
        const tabEl = isVideos ? els.videosTab : els.playlistsTab;
        const otherTabEl = isVideos ? els.playlistsTab : els.videosTab;
        const moreBtn = isVideos ? els.moreVideosBtn : els.morePlaylistsBtn;
        
        els.moreVideosBtn.classList.add('hidden');
        els.morePlaylistsBtn.classList.add('hidden');

        const pageTokenKey = isVideos ? 'videosPageToken' : 'playlistsPageToken';
        if (reset) { tabEl.innerHTML = ''; state.current[pageTokenKey] = null; }
        showStatus(`Lade ${type}...`, false);
        tabEl.classList.remove('hidden'); otherTabEl.classList.add('hidden');
        try {
            const info = await getChannelInfo(state.current.channelId);
            let data = isVideos 
                ? await api('playlistItems', { playlistId: info.uploadsId, pageToken: state.current[pageTokenKey], part: 'snippet,contentDetails' })
                : await api('playlists', { channelId: state.current.channelId, pageToken: state.current[pageTokenKey], part: 'snippet' });
            state.current[pageTokenKey] = data.nextPageToken || null;
            if (reset) tabEl.innerHTML = '';

            let items = (data.items || []).filter(it => it.snippet.thumbnails);
            if (isVideos) {
                items = await filterShortsByDuration(items, 'contentDetails');
            }

            items.forEach(it => {
                if (isVideos) {
                    tabEl.appendChild(videoCard({ videoId: it.contentDetails.videoId, title: it.snippet.title, date: it.contentDetails.videoPublishedAt, thumb: it.snippet.thumbnails?.medium?.url, channelTitle: info.title }, { channelId: info.id }));
                } else {
                    tabEl.appendChild(playlistCard({ playlistId: it.id, channelId: state.current.channelId, title: it.snippet.title, date: it.snippet.publishedAt, thumb: it.snippet.thumbnails?.medium?.url, channelTitle: info.title }));
                }
            });
            moreBtn.classList.toggle('hidden', !state.current[pageTokenKey]);
            hideStatus();
        } catch(e) { showStatus(`Fehler beim Laden von ${type}: ${e.message}`, true); }
    };
        
    const renderPlaylistVideos = async ({ reset = true } = {}) => {
        if (reset) { state.current.playlistVideosPageToken = null; els.playlistVideos.innerHTML = ''; }
        showStatus('Lade Playlist-Inhalte...', false);
        try {
            const info = await getChannelInfo(state.playlistContext.channelId);
            const data = await api('playlistItems', { playlistId: state.playlistContext.playlistId, pageToken: state.current.playlistVideosPageToken, maxResults: 15, part: 'snippet,contentDetails' });
            state.current.playlistVideosPageToken = data.nextPageToken || null;
            const playlistContext = { playlistId: state.playlistContext.playlistId, channelId: state.playlistContext.channelId };
            
            const nonShorts = await filterVideosByDuration(data.items || [], 'contentDetails');
            nonShorts.forEach(it => {
                els.playlistVideos.appendChild(videoCard({ videoId: it.contentDetails.videoId, title: it.snippet.title, date: it.contentDetails.videoPublishedAt, thumb: it.snippet.thumbnails.medium.url, channelTitle: info.title }, playlistContext));
            });

            els.morePlaylistVideosBtn.classList.toggle('hidden', !state.current.playlistVideosPageToken);
            hideStatus();
        } catch(e) { showStatus(`Fehler beim Laden der Playlist: ${e.message}`, true); }
    };

    const searchInChannel = async () => {
        const q = els.searchInput.value.trim();
        state.current.searchQuery = q;
        if (!q) {
            els.sortOptions.classList.add('hidden');
            showChannelContent(state.current.tab, { reset: true });
            return;
        }

        els.moreVideosBtn.classList.add('hidden');
        els.morePlaylistsBtn.classList.add('hidden');
        els.sortOptions.classList.remove('hidden');
        els.sortButtons.forEach(btn => btn.classList.toggle('active', btn.dataset.sort === state.current.searchOrder));
        
        const searchType = 'video';
        const tabEl = els.videosTab;
        
        showStatus(`Suche nach "${q}"...`);
        tabEl.innerHTML = '';
        try {
            const query = `"${q}"`;
            const data = await api('search', { channelId: state.current.channelId, q: query, type: searchType, part: 'snippet', maxResults: 25, order: state.current.searchOrder });
            const info = await getChannelInfo(state.current.channelId);
            
            let items = (data.items || []).filter(it => it.snippet.thumbnails);
            items = await filterVideosByDuration(items, 'id');

            items.forEach(it => {
                tabEl.appendChild(videoCard({ videoId: it.id.videoId, title: it.snippet.title, date: it.snippet.publishedAt, thumb: it.snippet.thumbnails.medium.url, channelTitle: info.title }, { channelId: state.current.channelId }));
            });
            hideStatus();
        } catch(e) { showStatus(`Suche fehlgeschlagen: ${e.message}`, true); }
    };

    // ===== NAVIGATION & ROUTING =====
    const navigate = (hash) => { window.location.hash = hash; };
    const parseRoute = () => {
        const h = window.location.hash.slice(1); if(!h) return {view: 'home'}; const parts = h.split('/');
        return { view: parts[0], id: parts[1], tab: parts[2], title: parts[3] ? decodeURIComponent(parts[3]) : null };
    };
    const setView = (name) => {
        els.homeView.classList.toggle('hidden', name !== 'home');
        els.channelView.classList.toggle('hidden', name !== 'channel');
        els.playlistView.classList.toggle('hidden', name !== 'playlist');
    };
    const backToChannel = () => {
        if(state.lastChannelRoute) navigate(state.lastChannelRoute);
        else if(state.current.channelId) navigate(`channel/${state.current.channelId}/playlists`);
        else navigate('home');
    };
    const openPlayer = async (videoId, title, context) => {
        els.playerTitle.textContent = title || 'Video';
        els.playerIframe.src = `https://www.youtube-nocookie.com/embed/${videoId}?rel=0&modestbranding=1&playsinline=1&autoplay=1`;
        els.overlay.classList.add('show');
        els.suggestList.innerHTML = '';
        try {
            let items = [];
            const currentChannelId = context?.channelId || state.current.channelId;
            const info = await getChannelInfo(currentChannelId);
            if (context?.playlistId) {
                const data = await api('playlistItems', { playlistId: context.playlistId, maxResults: 15, part: 'snippet,contentDetails' });
                items = data.items || [];
            } else if (currentChannelId) {
                const data = await api('playlistItems', { playlistId: info.uploadsId, maxResults: 15, part: 'snippet,contentDetails' });
                items = data.items;
            }

            const nonShorts = await filterVideosByDuration(items || [], 'contentDetails');
            nonShorts
                .filter(it => it.contentDetails.videoId !== videoId)
                .forEach(it => {
                    els.suggestList.appendChild(videoCard({ videoId: it.contentDetails.videoId, title: it.snippet.title, thumb: it.snippet.thumbnails?.medium?.url, channelTitle: info.title }, { channelId: currentChannelId }));
                });
        } catch(e) { console.warn("Could not load suggestions", e); }
    };
    const closePlayer = () => { els.overlay.classList.remove('show'); els.playerIframe.src = 'about:blank'; };
    const openPlaylist = (playlistId, channelId, title) => {
        state.lastChannelRoute = `channel/${channelId}/playlists`;
        navigate(`playlist/${playlistId}:${channelId}/${encodeURIComponent(title || '')}`);
    };
    
    const handleRoute = async () => {
        els.activeChannelPill.style.display = 'none'; 
        const r = parseRoute();
        hideStatus();
        try {
            if (r.view === 'home' || !r.view) {
                setView('home');
                await buildHome();
            } else if (r.view === 'channel' && r.id) {
                setView('channel'); 
                state.current.channelId = r.id; 
                state.current.tab = r.tab || 'videos';
                els.tabs.forEach(t => {
                    t.classList.remove('active');
                    if(t.dataset.tab === state.current.tab) t.classList.add('active');
                });
                const info = await getChannelInfo(r.id);
                els.activeChannelPill.textContent = info.title; 
                els.activeChannelPill.style.display = 'inline-flex'; 
                els.channelMeta.textContent = info.title;

                if (info.banner) {
                    els.channelBannerBackground.style.backgroundImage = `url(${info.banner})`;
                    els.channelBanner.style.backgroundImage = `url(${info.banner})`;
                    els.channelBannerContainer.classList.remove('hidden');
                } else {
                    els.channelBannerContainer.classList.add('hidden');
                }
                await showChannelContent(state.current.tab, { reset: true });
            } else if (r.view === 'playlist' && r.id) {
                setView('playlist'); 
                const [playlistId, channelId] = r.id.split(':');
                state.playlistContext = { playlistId, channelId, title: r.title || 'Playlist' };
                els.playlistTitle.textContent = state.playlistContext.title;
                const info = await getChannelInfo(channelId);
                els.activeChannelPill.textContent = info.title; 
                els.activeChannelPill.style.display = 'inline-flex';
                await renderPlaylistVideos({ reset: true });
            }
        } catch (e) {
            console.error(`Fehler bei Navigation zu #${r.view}:`, e);
            showStatus(e.message, true);
        }
    };
    
    // ===== EVENT LISTENERS =====
    const setupEventListeners = () => {
        window.addEventListener('hashchange', handleRoute);
        els.homeBtn.addEventListener('click', () => {
            navigate('home');
        });
        els.backBtn.addEventListener('click', () => history.back());
        els.forwardBtn.addEventListener('click', () => history.forward());
        els.backToChannelBtn.addEventListener('click', backToChannel);
        els.playerClose.addEventListener('click', closePlayer);
        els.overlay.addEventListener('click', e => { if (e.target === els.overlay) closePlayer(); });
        els.tabs.forEach(btn => {
            btn.addEventListener('click', () => { 
                if (state.current.channelId) {
                    navigate(`channel/${state.current.channelId}/${btn.dataset.tab}`);
                }
            });
        });
        els.moreVideosBtn.addEventListener('click', () => showChannelContent('videos', { reset: false }));
        els.morePlaylistsBtn.addEventListener('click', () => showChannelContent('playlists', { reset: false }));
        els.morePlaylistVideosBtn.addEventListener('click', () => renderPlaylistVideos({ reset: false }));
        
        els.searchBtn.addEventListener('click', () => searchInChannel());
        els.searchInput.addEventListener('keydown', e => { if (e.key === 'Enter') searchInChannel(); });
        els.sortButtons.forEach(btn => {
            btn.addEventListener('click', () => {
                state.current.searchOrder = btn.dataset.sort;
                searchInChannel();
            });
        });
    };

    // ===== APP INITIALIZATION =====
    const init = async () => {
        try {
            setupEventListeners();
            await handleRoute();
        } catch (e) {
            console.error("KRITISCHER FEHLER BEIM START:", e);
            showStatus(`Ein kritischer Fehler ist aufgetreten: ${e.message}`, true);
        }
    };
    
    init();
});
</script>

</body>
</html>
